<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®å¯è§†åŒ–å·¥å…· - æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-summary {
            font-weight: bold;
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>æ•°æ®å¯è§†åŒ–å·¥å…· - å•å…ƒæµ‹è¯•</h1>
    
    <div class="test-container">
        <h2>æµ‹è¯•æ§åˆ¶</h2>
        <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
    </div>
    
    <div class="test-container">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="test-results"></div>
        <div id="test-summary"></div>
    </div>

    <!-- å¼•å…¥è¢«æµ‹è¯•çš„æ¨¡å— -->
    <script src="../js/notification-system.js"></script>
    <script src="../js/file-handler.js"></script>
    <script src="../js/data-parser.js"></script>
    <script src="../js/chart-generator.js"></script>
    <script src="../js/export-manager.js"></script>

    <script>
        // ç®€å•çš„æµ‹è¯•æ¡†æ¶
        class TestRunner {
            constructor() {
                this.tests = [];
                this.results = [];
            }
            
            test(name, testFunction) {
                this.tests.push({ name, testFunction });
            }
            
            async runAll() {
                this.results = [];
                const resultsContainer = document.getElementById('test-results');
                resultsContainer.innerHTML = '';
                
                for (const test of this.tests) {
                    try {
                        await test.testFunction();
                        this.addResult(test.name, true);
                    } catch (error) {
                        this.addResult(test.name, false, error.message);
                    }
                }
                
                this.showSummary();
            }
            
            addResult(testName, passed, error = null) {
                this.results.push({ testName, passed, error });
                
                const resultsContainer = document.getElementById('test-results');
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                resultDiv.innerHTML = `
                    <strong>${passed ? 'âœ“' : 'âœ—'} ${testName}</strong>
                    ${error ? `<br><small>é”™è¯¯: ${error}</small>` : ''}
                `;
                resultsContainer.appendChild(resultDiv);
            }
            
            showSummary() {
                const passed = this.results.filter(r => r.passed).length;
                const total = this.results.length;
                const summaryContainer = document.getElementById('test-summary');
                
                summaryContainer.className = `test-summary ${passed === total ? 'test-pass' : 'test-fail'}`;
                summaryContainer.innerHTML = `
                    æµ‹è¯•å®Œæˆ: ${passed}/${total} é€šè¿‡
                    ${passed === total ? 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡!' : 'âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥'}
                `;
            }
        }
        
        const testRunner = new TestRunner();
        
        // æ–­è¨€å‡½æ•°
        function assert(condition, message) {
            if (!condition) {
                throw new Error(message || 'æ–­è¨€å¤±è´¥');
            }
        }
        
        function assertEquals(actual, expected, message) {
            if (actual !== expected) {
                throw new Error(message || `æœŸæœ›: ${expected}, å®é™…: ${actual}`);
            }
        }
        
        function assertNotNull(value, message) {
            if (value === null || value === undefined) {
                throw new Error(message || 'å€¼ä¸åº”ä¸ºnullæˆ–undefined');
            }
        }
        
        // æ–‡ä»¶å¤„ç†æµ‹è¯•
        testRunner.test('FileHandler.formatFileSize - åŸºæœ¬åŠŸèƒ½', () => {
            assertEquals(FileHandler.formatFileSize(0), '0 Bytes');
            assertEquals(FileHandler.formatFileSize(1024), '1 KB');
            assertEquals(FileHandler.formatFileSize(1048576), '1 MB');
            assertEquals(FileHandler.formatFileSize(1073741824), '1 GB');
        });
        
        testRunner.test('FileHandler.validateFileType - æ”¯æŒçš„æ–‡ä»¶ç±»å‹', () => {
            const xlsxFile = { name: 'test.xlsx', type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' };
            const csvFile = { name: 'test.csv', type: 'text/csv' };
            const txtFile = { name: 'test.txt', type: 'text/plain' };
            
            assert(FileHandler.validateFileType(xlsxFile), 'XLSXæ–‡ä»¶åº”è¯¥è¢«æ¥å—');
            assert(FileHandler.validateFileType(csvFile), 'CSVæ–‡ä»¶åº”è¯¥è¢«æ¥å—');
            assert(!FileHandler.validateFileType(txtFile), 'TXTæ–‡ä»¶åº”è¯¥è¢«æ‹’ç»');
        });
        
        // æ•°æ®è§£ææµ‹è¯•
        testRunner.test('DataParser.parseCSV - åŸºæœ¬CSVè§£æ', () => {
            const csvText = 'Name,Age,City\\nJohn,25,New York\\nJane,30,London';
            const result = DataParser.parseCSV(csvText);
            
            assertEquals(result.length, 3, 'åº”è¯¥è§£æå‡º3è¡Œæ•°æ®');
            assertEquals(result[0][0], 'Name', 'ç¬¬ä¸€è¡Œç¬¬ä¸€åˆ—åº”è¯¥æ˜¯Name');
            assertEquals(result[1][1], '25', 'ç¬¬äºŒè¡Œç¬¬äºŒåˆ—åº”è¯¥æ˜¯25');
        });
        
        testRunner.test('DataParser.detectColumnTypes - æ•°æ®ç±»å‹æ£€æµ‹', () => {
            const testData = [
                ['Name', 'Age', 'Score'],
                ['John', '25', '85.5'],
                ['Jane', '30', '92.0'],
                ['Bob', '28', '78.5']
            ];
            
            const types = DataParser.detectColumnTypes(testData);
            assertEquals(types[0], 'string', 'ç¬¬ä¸€åˆ—åº”è¯¥æ˜¯å­—ç¬¦ä¸²ç±»å‹');
            assertEquals(types[1], 'number', 'ç¬¬äºŒåˆ—åº”è¯¥æ˜¯æ•°å­—ç±»å‹');
            assertEquals(types[2], 'number', 'ç¬¬ä¸‰åˆ—åº”è¯¥æ˜¯æ•°å­—ç±»å‹');
        });
        
        testRunner.test('DataParser.validateData - æ•°æ®éªŒè¯', () => {
            const validData = [['Header1', 'Header2'], ['Value1', 'Value2']];
            const invalidData1 = [];
            const invalidData2 = [['Header1', 'Header2']];
            
            assert(DataParser.validateData(validData), 'æœ‰æ•ˆæ•°æ®åº”è¯¥é€šè¿‡éªŒè¯');
            assert(!DataParser.validateData(invalidData1), 'ç©ºæ•°æ®åº”è¯¥éªŒè¯å¤±è´¥');
            assert(!DataParser.validateData(invalidData2), 'åªæœ‰æ ‡é¢˜è¡Œçš„æ•°æ®åº”è¯¥éªŒè¯å¤±è´¥');
        });
        
        // å›¾è¡¨ç”Ÿæˆæµ‹è¯•
        testRunner.test('ChartGenerator.prepareData - æ•°æ®å‡†å¤‡', () => {
            const testData = [
                ['Month', 'Sales'],
                ['Jan', '1000'],
                ['Feb', '1200'],
                ['Mar', '900']
            ];
            
            const result = ChartGenerator.prepareData(testData, 0, 1);
            assertEquals(result.labels.length, 3, 'åº”è¯¥æœ‰3ä¸ªæ ‡ç­¾');
            assertEquals(result.values.length, 3, 'åº”è¯¥æœ‰3ä¸ªæ•°å€¼');
            assertEquals(result.labels[0], 'Jan', 'ç¬¬ä¸€ä¸ªæ ‡ç­¾åº”è¯¥æ˜¯Jan');
            assertEquals(result.values[0], 1000, 'ç¬¬ä¸€ä¸ªæ•°å€¼åº”è¯¥æ˜¯1000');
        });
        
        testRunner.test('ChartGenerator.getThemeColors - ä¸»é¢˜é¢œè‰²', () => {
            const blueColors = ChartGenerator.getThemeColors('blue');
            const greenColors = ChartGenerator.getThemeColors('green');
            const defaultColors = ChartGenerator.getThemeColors('nonexistent');
            
            assert(Array.isArray(blueColors), 'åº”è¯¥è¿”å›é¢œè‰²æ•°ç»„');
            assert(blueColors.length > 0, 'é¢œè‰²æ•°ç»„ä¸åº”ä¸ºç©º');
            assert(blueColors[0].startsWith('#'), 'é¢œè‰²åº”è¯¥æ˜¯åå…­è¿›åˆ¶æ ¼å¼');
            assertEquals(defaultColors, blueColors, 'ä¸å­˜åœ¨çš„ä¸»é¢˜åº”è¯¥è¿”å›é»˜è®¤è“è‰²ä¸»é¢˜');
        });
        
        // é€šçŸ¥ç³»ç»Ÿæµ‹è¯•
        testRunner.test('NotificationSystem.getTypeConfig - ç±»å‹é…ç½®', () => {
            const successConfig = NotificationSystem.getTypeConfig('success');
            const errorConfig = NotificationSystem.getTypeConfig('error');
            const defaultConfig = NotificationSystem.getTypeConfig('unknown');
            
            assertNotNull(successConfig.icon, 'æˆåŠŸé…ç½®åº”è¯¥æœ‰å›¾æ ‡');
            assertNotNull(errorConfig.bgColor, 'é”™è¯¯é…ç½®åº”è¯¥æœ‰èƒŒæ™¯è‰²');
            assertEquals(defaultConfig.icon, 'fa-info-circle', 'æœªçŸ¥ç±»å‹åº”è¯¥ä½¿ç”¨é»˜è®¤å›¾æ ‡');
        });
        
        // å¯¼å‡ºç®¡ç†æµ‹è¯•
        testRunner.test('ExportManager.checkBrowserSupport - æµè§ˆå™¨æ”¯æŒæ£€æŸ¥', () => {
            const support = ExportManager.checkBrowserSupport();
            
            assertNotNull(support.canvas, 'åº”è¯¥æ£€æŸ¥Canvasæ”¯æŒ');
            assertNotNull(support.download, 'åº”è¯¥æ£€æŸ¥ä¸‹è½½æ”¯æŒ');
            assertNotNull(support.blob, 'åº”è¯¥æ£€æŸ¥Blobæ”¯æŒ');
        });
        
        // å›¾è¡¨é”€æ¯æµ‹è¯•
        testRunner.test('ChartGenerator.safeDestroyChart - å®‰å…¨é”€æ¯', () => {
            // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„canvaså…ƒç´ 
            const mockCanvas = document.createElement('canvas');
            mockCanvas.id = 'test-canvas';
            document.body.appendChild(mockCanvas);
            
            // æ¨¡æ‹Ÿå›¾è¡¨å¯¹è±¡
            const mockChart = {
                destroy: function() {
                    this.destroyed = true;
                }
            };
            
            // æµ‹è¯•å®‰å…¨é”€æ¯
            ChartGenerator.safeDestroyChart(mockChart, mockCanvas);
            assert(mockChart.destroyed, 'å›¾è¡¨åº”è¯¥è¢«é”€æ¯');
            
            // æ¸…ç†
            document.body.removeChild(mockCanvas);
        });
        
        // è¾¹ç•Œæƒ…å†µæµ‹è¯•
        testRunner.test('è¾¹ç•Œæƒ…å†µ - ç©ºå­—ç¬¦ä¸²å¤„ç†', () => {
            assertEquals(FileHandler.formatFileSize(0), '0 Bytes');
            
            const emptyCSV = '';
            const result = DataParser.parseCSV(emptyCSV);
            assertEquals(result.length, 0, 'ç©ºCSVåº”è¯¥è¿”å›ç©ºæ•°ç»„');
        });
        
        testRunner.test('è¾¹ç•Œæƒ…å†µ - ç‰¹æ®Šå­—ç¬¦å¤„ç†', () => {
            const csvWithQuotes = 'Name,Description\\n"John, Jr.","A person with, comma"';
            const result = DataParser.parseCSV(csvWithQuotes);
            
            assertEquals(result.length, 2, 'åº”è¯¥æ­£ç¡®è§£æå¸¦å¼•å·çš„CSV');
            assertEquals(result[1][0], 'John, Jr.', 'åº”è¯¥æ­£ç¡®å¤„ç†å¼•å·å†…çš„é€—å·');
        });
        
        // è¿è¡Œæµ‹è¯•çš„å‡½æ•°
        function runAllTests() {
            testRunner.runAll();
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-summary').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            console.log('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥è¿è¡Œæµ‹è¯•');
        });
    </script>
</body>
</html>